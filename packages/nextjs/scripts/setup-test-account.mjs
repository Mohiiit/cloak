#!/usr/bin/env node

/**
 * Setup a Starknet Sepolia test account for automated E2E testing.
 *
 * Usage:
 *   node scripts/setup-test-account.mjs [--deploy]
 *
 * Steps:
 *   1. Generates a new keypair (or reads from .env.test if exists)
 *   2. Computes the OpenZeppelin account address
 *   3. Prints the address + faucet link for funding
 *   4. With --deploy flag, deploys the account (must be funded first)
 *   5. Writes .env.test with the credentials
 */

import { stark, ec, hash, CallData, Account, RpcProvider, constants } from "starknet";
import { readFileSync, writeFileSync, existsSync } from "fs";
import { resolve, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const ENV_TEST_PATH = resolve(__dirname, "../.env.test");
const ENV_PATH = resolve(__dirname, "../.env");

// OpenZeppelin Account class hash on Sepolia
// OZ Account v0.8.1 — confirmed declared on Sepolia
const OZ_ACCOUNT_CLASS_HASH = "0x04d07e40e93398ed3c76981e72dd1fd22557a78ce36c0515f679e27f0bb5bc5f";

// RPC URL — read from .env or use public
function getRpcUrl() {
  try {
    const envContent = readFileSync(ENV_PATH, "utf-8");
    const match = envContent.match(/NEXT_PUBLIC_SEPOLIA_PROVIDER_URL=(.+)/);
    if (match) return match[1].trim();
  } catch {}
  return "https://starknet-sepolia.public.blastapi.io/rpc/v0_9";
}

const RPC_URL = getRpcUrl();

function loadExisting() {
  if (!existsSync(ENV_TEST_PATH)) return null;
  const content = readFileSync(ENV_TEST_PATH, "utf-8");
  const address = content.match(/NEXT_PUBLIC_TEST_STARK_ADDRESS=(.+)/)?.[1]?.trim();
  const privateKey = content.match(/NEXT_PUBLIC_TEST_STARK_PRIVATE_KEY=(.+)/)?.[1]?.trim();
  if (address && privateKey) return { address, privateKey };
  return null;
}

function generateKeypair() {
  const privateKey = stark.randomAddress();
  const publicKey = ec.starkCurve.getStarkKey(privateKey);
  return { privateKey, publicKey };
}

function computeAddress(publicKey) {
  const constructorCalldata = CallData.compile({ publicKey });
  const address = hash.calculateContractAddressFromHash(
    publicKey, // salt
    OZ_ACCOUNT_CLASS_HASH,
    constructorCalldata,
    0, // deployer address (0 = universal deployer)
  );
  return address;
}

function writeEnvTest(address, privateKey) {
  const content = `# Test mode credentials for automated E2E testing on Sepolia
# Generated by scripts/setup-test-account.mjs
# DO NOT commit this file

NEXT_PUBLIC_TEST_MODE=true
NEXT_PUBLIC_TEST_STARK_ADDRESS=${address}
NEXT_PUBLIC_TEST_STARK_PRIVATE_KEY=${privateKey}
`;
  writeFileSync(ENV_TEST_PATH, content);
  console.log(`\nWritten to ${ENV_TEST_PATH}`);
}

async function checkBalance(address) {
  const provider = new RpcProvider({ nodeUrl: RPC_URL });
  try {
    // ETH contract on Sepolia
    const ethContract = "0x049d36570d4e46f48e99674bd3fcc84644ddd6b96f7c741b1562b82f9e004dc7";
    const result = await provider.callContract({
      contractAddress: ethContract,
      entrypoint: "balanceOf",
      calldata: [address],
    });
    const balance = BigInt(result[0]);
    return balance;
  } catch {
    return 0n;
  }
}

async function deployAccount(address, privateKey, publicKey) {
  const provider = new RpcProvider({ nodeUrl: RPC_URL });

  const account = new Account({
    provider,
    address,
    signer: privateKey,
  });

  const constructorCalldata = CallData.compile({ publicKey });

  console.log("\nDeploying account...");
  try {
    const { transaction_hash } = await account.deployAccount({
      classHash: OZ_ACCOUNT_CLASS_HASH,
      constructorCalldata,
      addressSalt: publicKey,
    });
    console.log(`Deploy tx: ${transaction_hash}`);
    console.log("Waiting for confirmation...");
    await provider.waitForTransaction(transaction_hash);
    console.log("Account deployed successfully!");
    return true;
  } catch (err) {
    console.error("Deploy failed:", err.message || err);
    return false;
  }
}

async function main() {
  const shouldDeploy = process.argv.includes("--deploy");

  console.log("=== Cloak Test Account Setup (Sepolia) ===\n");
  console.log(`RPC: ${RPC_URL}\n`);

  let privateKey, publicKey, address;

  // Check for existing credentials
  const existing = loadExisting();
  if (existing && !process.argv.includes("--new")) {
    console.log("Found existing test account in .env.test");
    privateKey = existing.privateKey;
    publicKey = ec.starkCurve.getStarkKey(privateKey);
    address = existing.address;
  } else {
    console.log("Generating new keypair...");
    const keypair = generateKeypair();
    privateKey = keypair.privateKey;
    publicKey = keypair.publicKey;
    address = computeAddress(publicKey);
  }

  console.log(`\nPrivate Key: ${privateKey}`);
  console.log(`Public Key:  ${publicKey}`);
  console.log(`Address:     ${address}`);

  // Check balance
  const balance = await checkBalance(address);
  const ethBalance = Number(balance) / 1e18;
  console.log(`\nETH Balance: ${ethBalance.toFixed(6)} ETH`);

  if (balance === 0n) {
    console.log("\n--- FUND THIS ACCOUNT ---");
    console.log(`\nCopy this address and fund it via the Starknet Sepolia faucet:`);
    console.log(`  ${address}`);
    console.log(`\nFaucets:`);
    console.log(`  https://starknet-faucet.vercel.app/`);
    console.log(`  https://faucet.blastapi.io/sepolia-eth/starknet`);
    console.log(`\nAfter funding, run again with --deploy:`);
    console.log(`  node scripts/setup-test-account.mjs --deploy`);
  }

  // Save credentials
  writeEnvTest(address, privateKey);

  if (shouldDeploy) {
    if (balance === 0n) {
      console.log("\nCannot deploy: account has no ETH for gas. Fund it first.");
      process.exit(1);
    }
    await deployAccount(address, privateKey, publicKey);
  }

  console.log("\n--- NEXT STEPS ---");
  console.log("1. Fund the address above via a Sepolia faucet");
  console.log("2. Run: node scripts/setup-test-account.mjs --deploy");
  console.log("3. Append .env.test vars to .env (or source it):");
  console.log("   cat packages/nextjs/.env.test >> packages/nextjs/.env");
  console.log("4. Restart dev server: yarn start");
  console.log("5. The app will auto-connect with the test account");
}

main().catch(console.error);
